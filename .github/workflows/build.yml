name: Build Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

env:
  QT_VERSION: '6.8.*'

jobs:
  # ==================== macOS Apple Silicon (arm64) ====================
  build-macos-arm64:
    runs-on: macos-14  # M1/M2 runner
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          modules: 'qtcharts'
          arch: 'clang_64'
          
      - name: Configure CMake
        working-directory: SLS_ThermoCalc
        run: |
          rm -rf build
          mkdir -p build/release
          cd build/release
          cmake ../.. -DCMAKE_BUILD_TYPE=Release -DCMAKE_OSX_ARCHITECTURES=arm64
          
      - name: Build
        working-directory: SLS_ThermoCalc/build/release
        run: cmake --build . --config Release -j$(sysctl -n hw.ncpu)
        
      - name: Deploy Qt and Create DMG
        working-directory: SLS_ThermoCalc
        run: |
          # å¤åˆ¶é¢„è®¾æ–‡ä»¶åˆ° app bundle
          mkdir -p bin/SLS_ThermoCalc.app/Contents/Resources/presets
          cp -r presets/* bin/SLS_ThermoCalc.app/Contents/Resources/presets/
          mkdir -p bin/SLS_ThermoCalc.app/Contents/Resources/config
          
          # éƒ¨ç½² Qt æ¡†æ¶
          macdeployqt bin/SLS_ThermoCalc.app -dmg
          mv bin/SLS_ThermoCalc.dmg SLS_ThermoCalc-macOS-arm64.dmg
          
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: SLS_ThermoCalc-macOS-arm64
          path: SLS_ThermoCalc/SLS_ThermoCalc-macOS-arm64.dmg

  # ==================== macOS Intel (x86_64) ====================
  build-macos-x64:
    runs-on: macos-13  # Intel runner
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          modules: 'qtcharts'
          arch: 'clang_64'
          
      - name: Configure CMake
        working-directory: SLS_ThermoCalc
        run: |
          rm -rf build
          mkdir -p build/release
          cd build/release
          cmake ../.. -DCMAKE_BUILD_TYPE=Release -DCMAKE_OSX_ARCHITECTURES=x86_64
          
      - name: Build
        working-directory: SLS_ThermoCalc/build/release
        run: cmake --build . --config Release -j$(sysctl -n hw.ncpu)
        
      - name: Deploy Qt and Create DMG
        working-directory: SLS_ThermoCalc
        run: |
          mkdir -p bin/SLS_ThermoCalc.app/Contents/Resources/presets
          cp -r presets/* bin/SLS_ThermoCalc.app/Contents/Resources/presets/
          mkdir -p bin/SLS_ThermoCalc.app/Contents/Resources/config
          
          macdeployqt bin/SLS_ThermoCalc.app -dmg
          mv bin/SLS_ThermoCalc.dmg SLS_ThermoCalc-macOS-x64.dmg
          
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: SLS_ThermoCalc-macOS-x64
          path: SLS_ThermoCalc/SLS_ThermoCalc-macOS-x64.dmg

  # ==================== Windows x64 ====================
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          modules: 'qtcharts'
          arch: 'win64_msvc2022_64'
          
      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
          
      - name: Configure CMake
        working-directory: SLS_ThermoCalc
        shell: cmd
        run: |
          if exist build rmdir /s /q build
          mkdir build\release
          cd build\release
          cmake ..\.. -G "NMake Makefiles" -DCMAKE_BUILD_TYPE=Release
          
      - name: Build
        working-directory: SLS_ThermoCalc/build/release
        shell: cmd
        run: cmake --build . --config Release
        
      - name: Deploy Qt
        working-directory: SLS_ThermoCalc
        shell: cmd
        run: |
          mkdir release
          copy bin\SLS_ThermoCalc.exe release\
          windeployqt release\SLS_ThermoCalc.exe
          xcopy presets release\presets\ /E /I
          mkdir release\config
          
      - name: Create ZIP
        working-directory: SLS_ThermoCalc
        shell: pwsh
        run: |
          Compress-Archive -Path release\* -DestinationPath SLS_ThermoCalc-Windows-x64.zip
          
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: SLS_ThermoCalc-Windows-x64
          path: SLS_ThermoCalc/SLS_ThermoCalc-Windows-x64.zip

  # ==================== Linux x64 (Ubuntu) ====================
  build-linux-x64:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            libgl1-mesa-dev \
            libxkbcommon-x11-0 \
            libxcb-cursor0 \
            libxcb-icccm4 \
            libxcb-image0 \
            libxcb-keysyms1 \
            libxcb-randr0 \
            libxcb-render-util0 \
            libxcb-shape0 \
            libxcb-xfixes0 \
            libxcb-xinerama0 \
            libfuse2
      
      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          modules: 'qtcharts'
          
      - name: Configure CMake
        working-directory: SLS_ThermoCalc
        run: |
          rm -rf build
          mkdir -p build/release
          cd build/release
          cmake ../.. -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr
          
      - name: Build
        working-directory: SLS_ThermoCalc/build/release
        run: cmake --build . --config Release -j$(nproc)
        
      - name: Install linuxdeployqt
        run: |
          wget -c https://github.com/probonopd/linuxdeployqt/releases/download/continuous/linuxdeployqt-continuous-x86_64.AppImage
          chmod +x linuxdeployqt-continuous-x86_64.AppImage
          
      - name: Create AppImage
        working-directory: SLS_ThermoCalc
        run: |
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
          mkdir -p AppDir/usr/share/SLS_ThermoCalc/presets
          mkdir -p AppDir/usr/share/SLS_ThermoCalc/config
          
          cp bin/SLS_ThermoCalc AppDir/usr/bin/
          cp -r presets/* AppDir/usr/share/SLS_ThermoCalc/presets/
          
          # åˆ›å»º desktop æ–‡ä»¶
          cat > AppDir/usr/share/applications/SLS_ThermoCalc.desktop << EOF
          [Desktop Entry]
          Type=Application
          Name=SLS ThermoCalc
          Comment=ç«ç®­å‘åŠ¨æœºçƒ­åŠ›æ€§èƒ½è®¡ç®—ç¨‹åº
          Exec=SLS_ThermoCalc
          Icon=SLS_ThermoCalc
          Categories=Science;Engineering;
          Terminal=false
          EOF
          
          # ä½¿ç”¨é»˜è®¤å›¾æ ‡ (å¦‚æœæ²¡æœ‰ä¸“ç”¨å›¾æ ‡)
          cp /usr/share/icons/hicolor/256x256/apps/utilities-terminal.png \
             AppDir/usr/share/icons/hicolor/256x256/apps/SLS_ThermoCalc.png 2>/dev/null || \
          convert -size 256x256 xc:#2196F3 -fill white -gravity center \
             -pointsize 48 -annotate 0 "SLS" \
             AppDir/usr/share/icons/hicolor/256x256/apps/SLS_ThermoCalc.png 2>/dev/null || \
          echo "Icon not created, continuing..."
          
          cp AppDir/usr/share/applications/SLS_ThermoCalc.desktop AppDir/
          
          # åˆ›å»º AppImage
          cd ..
          ./linuxdeployqt-continuous-x86_64.AppImage \
            SLS_ThermoCalc/AppDir/usr/share/applications/SLS_ThermoCalc.desktop \
            -appimage -no-translations \
            -extra-plugins=iconengines,platformthemes/libqgtk3.so || true
          
          # é‡å‘½å AppImage
          mv SLS_ThermoCalc*.AppImage SLS_ThermoCalc/SLS_ThermoCalc-Linux-x64.AppImage 2>/dev/null || \
          mv *.AppImage SLS_ThermoCalc/SLS_ThermoCalc-Linux-x64.AppImage 2>/dev/null || true
          
      - name: Fallback to tar.gz if AppImage fails
        working-directory: SLS_ThermoCalc
        run: |
          if [ ! -f "SLS_ThermoCalc-Linux-x64.AppImage" ]; then
            echo "AppImage creation failed, creating tar.gz instead..."
            mkdir -p release/bin release/presets release/config
            cp bin/SLS_ThermoCalc release/bin/
            cp -r presets/* release/presets/
            tar -czvf SLS_ThermoCalc-Linux-x64.tar.gz -C release .
          fi
          
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: SLS_ThermoCalc-Linux-x64
          path: |
            SLS_ThermoCalc/SLS_ThermoCalc-Linux-x64.AppImage
            SLS_ThermoCalc/SLS_ThermoCalc-Linux-x64.tar.gz
          if-no-files-found: warn

  # ==================== Create GitHub Release ====================
  release:
    needs: [build-macos-arm64, build-macos-x64, build-windows, build-linux-x64]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          
      - name: List artifacts
        run: find artifacts -type f
          
      - name: Prepare release files
        run: |
          mkdir -p release_files
          find artifacts -type f \( -name "*.dmg" -o -name "*.zip" -o -name "*.AppImage" -o -name "*.tar.gz" \) \
            -exec cp {} release_files/ \;
          ls -la release_files/
          
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: release_files/*
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## ä¸‹è½½è¯´æ˜
            
            | å¹³å° | æ–‡ä»¶ | è¯´æ˜ |
            |------|------|------|
            | ğŸ macOS (Apple Silicon) | `SLS_ThermoCalc-macOS-arm64.dmg` | M1/M2/M3 èŠ¯ç‰‡ Mac |
            | ğŸ macOS (Intel) | `SLS_ThermoCalc-macOS-x64.dmg` | Intel èŠ¯ç‰‡ Mac |
            | ğŸªŸ Windows | `SLS_ThermoCalc-Windows-x64.zip` | Windows 10/11 64ä½ |
            | ğŸ§ Linux | `SLS_ThermoCalc-Linux-x64.AppImage` | Ubuntu/Debian ç­‰å‘è¡Œç‰ˆ |
            
            ### å®‰è£…è¯´æ˜
            
            **macOS**: 
            1. æ‰“å¼€ DMG æ–‡ä»¶
            2. å°†åº”ç”¨æ‹–åˆ° Applications æ–‡ä»¶å¤¹
            3. é¦–æ¬¡æ‰“å¼€æ—¶å³é”®é€‰æ‹©"æ‰“å¼€"ä»¥ç»•è¿‡ Gatekeeper
            
            **Windows**:
            1. è§£å‹ ZIP æ–‡ä»¶
            2. è¿è¡Œ `SLS_ThermoCalc.exe`
            
            **Linux**:
            1. èµ‹äºˆæ‰§è¡Œæƒé™: `chmod +x SLS_ThermoCalc-Linux-x64.AppImage`
            2. è¿è¡Œ: `./SLS_ThermoCalc-Linux-x64.AppImage`
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
